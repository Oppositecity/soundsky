<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>SoundFeed - Share Audio on Bluesky</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
        }

        header {
            text-align: center;
            color: white;
            margin-bottom: 40px;
        }

        header h1 {
            font-size: 3em;
            margin-bottom: 10px;
        }

        .section {
            background: white;
            border-radius: 12px;
            padding: 30px;
            margin-bottom: 20px;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }

        .section h2 {
            margin-bottom: 20px;
            color: #333;
        }

        .hidden {
            display: none;
        }

        form {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        input[type="text"],
        input[type="password"],
        input[type="file"] {
            padding: 12px;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s;
        }

        input[type="text"]:focus,
        input[type="password"]:focus {
            outline: none;
            border-color: #667eea;
        }

        button {
            padding: 12px 24px;
            background: #667eea;
            color: white;
            border: none;
            border-radius: 8px;
            font-size: 16px;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.3s;
        }

        button:hover {
            background: #5568d3;
        }

        .note {
            margin-top: 15px;
            font-size: 14px;
            color: #666;
        }

        .note a {
            color: #667eea;
        }

        #upload-status {
            margin-top: 15px;
            padding: 12px;
            border-radius: 8px;
            font-weight: 500;
        }

        #upload-status.success {
            background: #d4edda;
            color: #155724;
        }

        #upload-status.error {
            background: #f8d7da;
            color: #721c24;
        }

        #upload-status.loading {
            background: #d1ecf1;
            color: #0c5460;
        }

        #user-info {
            background: rgba(255,255,255,0.9);
            border-radius: 12px;
            padding: 20px;
            text-align: center;
            color: #333;
        }

        #user-handle {
            font-weight: 600;
            color: #667eea;
        }

        .audio-post {
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            padding: 20px;
            margin-bottom: 15px;
        }

        .post-author {
            font-weight: 600;
            color: #667eea;
            margin-bottom: 10px;
        }

        .post-text {
            margin-bottom: 15px;
            color: #333;
        }

        .track-title {
            font-weight: 600;
            margin-bottom: 10px;
            color: #764ba2;
        }

        audio {
            width: 100%;
            margin-top: 10px;
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>üéµ SoundFeed</h1>
            <p>Share audio directly on Bluesky</p>
        </header>

        <!-- Login Section -->
        <div id="login-section" class="section">
            <h2>Login to Bluesky</h2>
            <form id="login-form">
                <input 
                    type="text" 
                    id="handle" 
                    placeholder="your-handle.bsky.social" 
                    required
                />
                <input 
                    type="password" 
                    id="password" 
                    placeholder="App Password" 
                    required
                />
                <button type="submit">Login</button>
            </form>
            <p class="note">
                Use an <a href="https://bsky.app/settings/app-passwords" target="_blank">App Password</a>, 
                not your main password!
            </p>
        </div>

        <!-- Upload Section -->
        <div id="upload-section" class="section hidden">
            <h2>Upload Audio</h2>
            <form id="upload-form">
                <input 
                    type="file" 
                    id="audio-file" 
                    accept=".wav,.mp3,.flac,.m4a"
                    required
                />
                <input 
                    type="text" 
                    id="post-text" 
                    placeholder="Say something about this track..." 
                    maxlength="300"
                />
                <input 
                    type="text" 
                    id="track-title" 
                    placeholder="Track title (optional)" 
                />
                <button type="submit">Post Audio</button>
            </form>
            <div id="upload-status"></div>
        </div>

        <!-- Feed Section -->
        <div id="feed-section" class="section hidden">
            <h2>Audio Feed</h2>
            <div id="audio-feed"></div>
        </div>

        <!-- User Info -->
        <div id="user-info" class="hidden">
            <p>Logged in as: <span id="user-handle"></span></p>
            <button id="logout-btn">Logout</button>
        </div>
    </div>

    <script type="module">
        import { BskyAgent } from 'https://esm.sh/@atproto/api@0.13.20';

        const AUDIO_EMBED_TYPE = 'com.soundfeed.embed.audio';
        let agent = null;

        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('login-form').addEventListener('submit', handleLogin);
            document.getElementById('upload-form').addEventListener('submit', handleUpload);
            document.getElementById('logout-btn').addEventListener('click', handleLogout);
        });

        async function handleLogin(e) {
            e.preventDefault();
            const handle = document.getElementById('handle').value;
            const password = document.getElementById('password').value;
            const statusDiv = document.getElementById('upload-status');
            
            statusDiv.textContent = 'Logging in...';
            statusDiv.className = 'loading';
            
            try {
                agent = new BskyAgent({ service: 'https://bsky.social' });
                await agent.login({ identifier: handle, password: password });
                
                document.getElementById('login-section').classList.add('hidden');
                document.getElementById('upload-section').classList.remove('hidden');
                document.getElementById('feed-section').classList.remove('hidden');
                document.getElementById('user-info').classList.remove('hidden');
                document.getElementById('user-handle').textContent = handle;
                
                statusDiv.textContent = '';
                statusDiv.className = '';
                
                loadAudioFeed();
            } catch (error) {
                console.error('Login failed:', error);
                statusDiv.textContent = '‚ùå Login failed. Check credentials & use App Password!';
                statusDiv.className = 'error';
            }
        }

        async function handleUpload(e) {
            e.preventDefault();
            const fileInput = document.getElementById('audio-file');
            const postText = document.getElementById('post-text').value;
            const trackTitle = document.getElementById('track-title').value;
            const statusDiv = document.getElementById('upload-status');
            
            if (!fileInput.files.length) {
                statusDiv.textContent = '‚ùå Please select an audio file';
                statusDiv.className = 'error';
                return;
            }
            
            const file = fileInput.files[0];
            if (file.size > 50 * 1024 * 1024) {
                statusDiv.textContent = '‚ùå File too large. Max 50MB.';
                statusDiv.className = 'error';
                return;
            }
            
            try {
                statusDiv.textContent = 'Reading file...';
                statusDiv.className = 'loading';
                
                // Use FileReader for better mobile compatibility
                const uint8Array = await new Promise((resolve, reject) => {
                    const reader = new FileReader();
                    reader.onload = () => {
                        resolve(new Uint8Array(reader.result));
                    };
                    reader.onerror = () => reject(new Error('Failed to read file'));
                    reader.readAsArrayBuffer(file);
                });
                
                statusDiv.textContent = 'Uploading to Bluesky...';
                
                const blobResponse = await agent.uploadBlob(uint8Array, {
                    encoding: file.type || 'audio/wav'
                });
                
                statusDiv.textContent = 'Creating post...';
                
                await agent.post({
                    text: postText || 'üéµ',
                    createdAt: new Date().toISOString(),
                    embed: {
                        $type: AUDIO_EMBED_TYPE,
                        audio: blobResponse.data.blob,
                        title: trackTitle || file.name,
                        mimeType: file.type || 'audio/wav',
                        size: file.size
                    }
                });
                
                statusDiv.textContent = '‚úÖ Posted successfully!';
                statusDiv.className = 'success';
                document.getElementById('upload-form').reset();
                
                setTimeout(() => {
                    statusDiv.textContent = '';
                    statusDiv.className = '';
                    loadAudioFeed();
                }, 2000);
            } catch (error) {
                console.error('Upload failed:', error);
                statusDiv.textContent = '‚ùå Upload failed: ' + error.message;
                statusDiv.className = 'error';
            }
        }

        async function loadAudioFeed() {
            const feedDiv = document.getElementById('audio-feed');
            feedDiv.innerHTML = '<p style="text-align:center;">Loading...</p>';
            
            try {
                const response = await agent.getTimeline({ limit: 50 });
                const audioPosts = response.data.feed.filter(item => 
                    item.post.embed && item.post.embed.$type === AUDIO_EMBED_TYPE
                );
                
                if (audioPosts.length === 0) {
                    feedDiv.innerHTML = '<p style="text-align:center;color:#999;">No audio posts yet!</p>';
                    return;
                }
                
                feedDiv.innerHTML = '';
                audioPosts.forEach(item => {
                    const div = document.createElement('div');
                    div.className = 'audio-post';
                    
                    div.innerHTML = `
                        <div class="post-author">@${item.post.author.handle}</div>
                        ${item.post.embed.title ? `<div class="track-title">${item.post.embed.title}</div>` : ''}
                        ${item.post.record.text ? `<div class="post-text">${item.post.record.text}</div>` : ''}
                        <audio controls src="https://bsky.social/xrpc/com.atproto.sync.getBlob?did=${item.post.author.did}&cid=${item.post.embed.audio.ref.$link}"></audio>
                    `;
                    
                    feedDiv.appendChild(div);
                });
            } catch (error) {
                console.error('Feed failed:', error);
                feedDiv.innerHTML = '<p style="text-align:center;color:#dc3545;">Failed to load feed</p>';
            }
        }

        function handleLogout() {
            agent = null;
            document.getElementById('login-section').classList.remove('hidden');
            document.getElementById('upload-section').classList.add('hidden');
            document.getElementById('feed-section').classList.add('hidden');
            document.getElementById('user-info').classList.add('hidden');
            document.getElementById('login-form').reset();
        }
    </script>
</body>
</html>